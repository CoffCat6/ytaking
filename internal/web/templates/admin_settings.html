{{define "content"}}
<section class="section admin">
  <div class="section-head">
    <h1>{{.PageTitle}}</h1>
    <p>更新站点标题、简介与联系方式。</p>
  </div>
  {{if .Error}}
  <div class="form-error">{{.Error}}</div>
  {{end}}
  <form class="admin-form" method="post" action="/admin/settings">
    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
    <label>
      站点标题
      <input type="text" name="title" value="{{.Profile.Title}}" required />
    </label>
    <label>
      标语
      <input type="text" name="tagline" value="{{.Profile.Tagline}}" />
    </label>
    <label>
      简介
      <textarea name="intro" rows="3">{{.Profile.Intro}}</textarea>
    </label>
    <label>
      个人简历 <span style="color: var(--muted); font-size: 12px; font-weight: normal;">(支持 Markdown 格式，显示在首页 Hero 区域)</span>
      <textarea name="hero_bio" rows="8" placeholder="支持 Markdown 格式，例如：&#10;&#10;## 关于我&#10;&#10;我是一名**产品工程师**，专注于：&#10;&#10;- 产品设计&#10;- 全栈开发&#10;- 技术写作&#10;&#10;> 长期主义者，相信复利的力量。">{{.Profile.HeroBio}}</textarea>
    </label>
    <label>
      一句话定位
      <input type="text" name="positioning" value="{{.Profile.Positioning}}" placeholder="例如：长期主义的产品与工程作者" />
    </label>
    <label>
      擅长领域
      <textarea name="skills" rows="4" placeholder="每行一个领域">{{.SkillsText}}</textarea>
    </label>
    <label>
      头像链接
      <div style="display:flex; gap:8px; align-items:center;">
        <input type="text" id="avatar-input" name="avatar" value="{{.Profile.Avatar}}" placeholder="https://example.com/avatar.png" style="flex:1;" />
        <input type="file" id="avatar-upload-file" accept="image/*" style="display:none" />
        <button type="button" class="secondary-btn" id="avatar-upload-btn" style="padding:8px 12px; font-size:14px;">上传</button>
      </div>
    </label>
    <label>
      地点
      <input type="text" name="location" value="{{.Profile.Location}}" />
    </label>
    <label>
      邮箱
      <input type="email" name="email" value="{{.Profile.Email}}" />
    </label>
    <label>
      通讯
      <textarea name="newsletter" rows="3">{{.Profile.Newsletter}}</textarea>
    </label>
    <label>
      社交链接
      <textarea name="social_links" rows="5" placeholder="每行一个：名称|链接">{{.SocialText}}</textarea>
    </label>
    <label>
      当前在做
      <textarea name="current_focus" rows="4" placeholder="每行一条">{{.FocusText}}</textarea>
    </label>
    <div class="admin-actions">
      <button class="primary-btn" type="submit">保存设置</button>
      <a class="secondary-btn" href="/admin/logout">退出</a>
      <a class="secondary-btn" href="/admin/posts">返回管理</a>
    </div>
  </form>
  <script>
    (function () {
      var uploadBtn = document.getElementById('avatar-upload-btn');
      var uploadFile = document.getElementById('avatar-upload-file');
      var avatarInput = document.getElementById('avatar-input');
      if (!uploadBtn || !uploadFile || !avatarInput) return;

      uploadBtn.addEventListener('click', function () {
        uploadFile.click();
      });

      uploadFile.addEventListener('change', function () {
        if (uploadFile.files.length === 0) return;
        var originalText = uploadBtn.textContent;
        uploadBtn.textContent = '上传中...';
        uploadBtn.disabled = true;

        var fd = new FormData();
        fd.append('file', uploadFile.files[0]);
        fd.append('csrf_token', document.querySelector('input[name="csrf_token"]').value);

        fetch('/admin/upload', { method: 'POST', body: fd })
          .then(function (r) {
            if (!r.ok) throw new Error('上传失败');
            return r.json();
          })
          .then(function (data) {
            if (data.url) avatarInput.value = data.url;
          })
          .catch(function (e) { alert(e.message); })
          .finally(function () {
            uploadBtn.textContent = originalText;
            uploadBtn.disabled = false;
            uploadFile.value = '';
          });
      });
    })();
  </script>
</section>
{{end}}
