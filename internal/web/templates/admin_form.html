{{define "content"}}
<section class="section admin">
  <div class="section-head">
    <h1>{{.PageTitle}}</h1>
    <p>填写标题、slug、摘要与正文。</p>
  </div>
  {{if .Error}}
  <div class="form-error">{{.Error}}</div>
  {{end}}
  <form class="admin-form" method="post" action="{{.Action}}">
    <input type="hidden" name="csrf_token" value="{{.CSRFToken}}" />
    <label>
      标题
      <input type="text" name="title" value="{{.Post.Title}}" required />
    </label>
    <label>
      Slug
      <input type="text" name="slug" value="{{.Post.Slug}}" placeholder="english-slug" />
    </label>
    <label>
      摘要
      <textarea name="summary" rows="3">{{.Post.Summary}}</textarea>
    </label>
    <label>
      预览图
      <div style="display: flex; gap: 8px; align-items: center;">
        <input type="text" id="cover-input" name="cover_image" value="{{.Post.CoverImage}}" placeholder="https://example.com/cover.jpg" style="flex: 1;" />
        <input type="file" id="upload-file" style="display: none" accept="image/*" />
        <button type="button" class="secondary-btn" id="upload-btn" style="padding: 8px 12px; font-size: 14px;">上传</button>
      </div>
    </label>
    <label>
      分类
      <input type="text" name="category" value="{{.Post.Category}}" placeholder="产品/工程" />
    </label>
    <label>
      标签
      <input type="text" name="tags" value="{{joinTags .Post.Tags}}" placeholder="Go,写作" />
    </label>
    <div style="display: flex; gap: 24px;">
      <label class="checkbox-field">
        <input type="checkbox" name="featured" {{if .Post.Featured}}checked{{end}} />
        设为精选文章
      </label>
      <label class="checkbox-field">
        <input type="checkbox" name="is_draft" {{if .Post.IsDraft}}checked{{end}} />
        设为草稿 (不发布)
      </label>
    </div>
    <label>
      正文 (Markdown)
      <div style="margin-bottom: 8px;">
        <button type="button" class="secondary-btn" id="insert-img-btn" style="padding: 4px 8px; font-size: 12px;">插入图片</button>
        <input type="file" id="insert-img-file" style="display: none" accept="image/*" />
      </div>
      <textarea id="content-area" name="content" rows="10">{{.Post.Content}}</textarea>
    </label>
    <div class="admin-actions">
      <button class="primary-btn" type="submit">保存</button>
<script>
  function uploadFile(fileInput, btnId, onSuccess) {
    if (fileInput.files.length === 0) return;
    var btn = document.getElementById(btnId);
    var originalText = btn.textContent;
    btn.textContent = "上传中...";
    btn.disabled = true;
    
    var formData = new FormData();
    formData.append("file", fileInput.files[0]);
    formData.append("csrf_token", document.querySelector('input[name="csrf_token"]').value);
    
    fetch("/admin/upload", {
      method: "POST",
      body: formData
    })
    .then(r => {
      if (!r.ok) throw new Error("Upload failed");
      return r.json();
    })
    .then(data => {
      if (data.url) {
        onSuccess(data.url);
      }
    })
    .catch(e => alert(e.message))
    .finally(() => {
      btn.textContent = originalText;
      btn.disabled = false;
      fileInput.value = "";
    });
  }

  // Cover Image Upload
  document.getElementById("upload-btn").addEventListener("click", function() {
    document.getElementById("upload-file").click();
  });
  document.getElementById("upload-file").addEventListener("change", function() {
    uploadFile(this, "upload-btn", function(url) {
      document.getElementById("cover-input").value = url;
    });
  });

  // Content Image Insert
  document.getElementById("insert-img-btn").addEventListener("click", function() {
    document.getElementById("insert-img-file").click();
  });
  document.getElementById("insert-img-file").addEventListener("change", function() {
    uploadFile(this, "insert-img-btn", function(url) {
      var textarea = document.getElementById("content-area");
      var cursorPosition = textarea.selectionStart;
      var textBefore = textarea.value.substring(0,  cursorPosition);
      var textAfter  = textarea.value.substring(cursorPosition, textarea.value.length);
      var imageMarkdown = "\n![](" + url + ")\n";
      textarea.value = textBefore + imageMarkdown + textAfter;
    });
  });
</script>
      <a class="secondary-btn" href="/admin/posts">取消</a>
    </div>
  </form>
</section>
{{end}}
